{% extends "layout.html" %} {% block title %}LLMChat Web REPL{% endblock %} {%
block head_extra %}
<style>
    /* Custom styles for llmchat-web layout */
    body {
        background-color: #212529; /* Dark background for the whole page */
        color: #dee2e6; /* Light text color */
        overflow-x: hidden; /* Prevent horizontal scroll */
    }

    #app-container {
        display: flex;
        flex-direction: column;
        height: 100vh; /* Full viewport height */
    }

    /* Top Bar */
    .top-bar {
        background-color: #343a40; /* Slightly lighter dark for top bar */
        padding: 0.5rem 1rem;
        color: #f8f9fa;
        flex-shrink: 0; /* Prevent top bar from shrinking */
        font-size: 0.85rem;
    }
    .top-bar .status-item {
        margin-right: 15px;
    }
    .top-bar .status-item .badge {
        font-size: 0.8rem;
    }
    .top-bar .llmchat-brand {
        font-weight: bold;
    }

    /* Main Layout: Sidebar + Content + Bottom Bar */
    .main-layout {
        display: flex;
        flex-grow: 1; /* Allow this section to grow and fill available space */
        overflow: hidden; /* Prevent overflow from this central part */
    }

    /* Left Sidebar */
    .left-sidebar {
        width: 280px;
        background-color: #2c3034; /* Darker sidebar */
        padding: 1rem;
        display: flex;
        flex-direction: column;
        overflow-y: auto; /* Scroll for session list */
        flex-shrink: 0;
        border-right: 1px solid #495057;
    }
    .left-sidebar h5 {
        color: #adb5bd;
    }
    .left-sidebar .list-group-item {
        background-color: #343a40;
        border-color: #495057;
        color: #dee2e6;
        cursor: pointer;
        margin-bottom: 5px;
        border-radius: 0.25rem;
    }
    .left-sidebar .list-group-item.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
    }
    .left-sidebar .list-group-item:hover {
        background-color: #495057;
    }
    .left-sidebar .btn-group .btn {
        font-size: 0.9rem;
    }

    /* Main Content Area */
    .main-content-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column; /* Stack tabs content and chat input */
        background-color: #2b2b2b; /* Slightly different dark for content */
        padding: 0; /* Tabs will handle their own padding */
        overflow: hidden; /* Ensure content area itself doesn't cause scrollbars */
    }

    .main-content-area .nav-tabs .nav-link {
        color: #adb5bd;
        border-top-left-radius: 0.25rem;
        border-top-right-radius: 0.25rem;
        background-color: #343a40;
        border-bottom-color: #2b2b2b; /* Match content background */
        margin-right: 2px;
    }
    .main-content-area .nav-tabs .nav-link.active {
        color: #f8f9fa;
        background-color: #2b2b2b; /* Active tab matches content background */
        border-color: #495057 #495057 #2b2b2b;
    }
    .main-content-area .tab-content {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto; /* Allow content within tabs to scroll */
        background-color: #2b2b2b;
    }
    /* Ensure sub-tab content also fills height */
    #contextSubTabsContent {
        height: 100%;
    }
    #contextSubTabsContent .tab-pane {
        height: 100%;
    }

    /* Chat Tab Specifics */
    #chat-messages {
        height: 100%; /* Take full height of its container */
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-direction: column-reverse; /* New messages at the bottom, scroll up */
    }
    .message-bubble {
        padding: 8px 12px;
        border-radius: 15px;
        margin-bottom: 10px;
        max-width: 75%;
        word-wrap: break-word;
    }
    .user-message {
        background-color: #007bff; /* Bootstrap primary blue */
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
    }
    .agent-message {
        background-color: #495057; /* Darker gray for agent */
        color: #f8f9fa;
        align-self: flex-start;
        border-bottom-left-radius: 5px;
    }
    .message-bubble.error-message-bubble {
        background-color: #dc3545; /* Bootstrap danger red for errors */
        color: white;
    }
    .message-actions {
        font-size: 0.75rem; /* Smaller action buttons */
    }
    .message-actions .btn {
        padding: 0.1rem 0.3rem; /* Smaller padding for buttons */
    }

    /* Chat input is now in the bottom bar, styles adjusted */
    #chat-input-area {
        padding: 10px;
        background-color: #343a40;
    }
    #chat-input-area textarea {
        background-color: #2c3034;
        color: #dee2e6;
        border-color: #495057;
    }
    #chat-input-area textarea::placeholder {
        color: #6c757d;
    }

    /* Bottom Control Bar */
    .bottom-control-bar {
        background-color: #343a40;
        padding: 0; /* Tabs will handle padding */
        flex-shrink: 0; /* Prevent bottom bar from shrinking */
        border-top: 1px solid #495057;
    }
    .bottom-control-bar .nav-tabs .nav-link {
        color: #adb5bd;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        border-bottom-left-radius: 0.25rem;
        border-bottom-right-radius: 0.25rem;
        background-color: #2c3034; /* Slightly darker than bar itself for inactive tabs */
        border-top-color: #343a40; /* Match bar background */
        margin-right: 2px;
    }
    .bottom-control-bar .nav-tabs .nav-link.active {
        color: #f8f9fa;
        background-color: #343a40; /* Active tab matches bar background */
        border-color: #495057 #495057 #343a40;
    }
    .bottom-control-bar .tab-content {
        padding: 0; /* Remove padding, #chat-input-area has its own */
        background-color: #343a40;
    }
    .bottom-control-bar .form-control,
    .bottom-control-bar .form-select,
    .bottom-control-bar .btn {
        font-size: 0.9rem;
    }
    .bottom-control-bar .form-control,
    .bottom-control-bar .form-select {
        background-color: #2c3034;
        color: #dee2e6;
        border-color: #495057;
    }
    .bottom-control-bar .form-control::placeholder {
        color: #6c757d;
    }
    .bottom-control-bar .form-check-input {
        background-color: #495057;
        border-color: #6c757d;
    }
    .bottom-control-bar .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    /* Utility for full height flex column (used by main-content-area and its tab-content) */
    .d-flex-fill-column {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow: hidden;
    }
    .tab-pane-full-height {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    /* Workspace & RAG Tab Styling */
    .workspace-item,
    .staged-context-item {
        background-color: #3a3f44;
        border: 1px solid #495057;
        border-radius: 0.25rem;
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.5rem;
    }
    .workspace-item-header,
    .staged-item-header {
        font-size: 0.9rem;
        font-weight: bold;
        color: #adb5bd;
    }
    .workspace-item-content-preview,
    .staged-item-content-preview {
        font-size: 0.85rem;
        color: #ced4da;
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: pre-wrap;
    }
    .workspace-item-actions .btn,
    .staged-item-actions .btn {
        font-size: 0.75rem;
        padding: 0.1rem 0.3rem;
    }
    #context-preview-query-input {
        background-color: #2c3034;
        color: #dee2e6;
        border-color: #495057;
    }
    #context-preview-query-input::placeholder {
        color: #6c757d;
    }

    /* Ingestion Modal Styling */
    #ingestionModal .nav-tabs .nav-link {
        background-color: #495057; /* Darker inactive tab for modal */
        color: #adb5bd;
        border-bottom-color: #343a40; /* Match modal body background */
    }
    #ingestionModal .nav-tabs .nav-link.active {
        background-color: #343a40; /* Active tab matches modal body */
        color: #f8f9fa;
        border-color: #495057 #495057 #343a40;
    }
    #ingestionModal .form-label {
        font-size: 0.9rem;
    }
    #ingestionModal .form-control,
    #ingestionModal .form-select {
        font-size: 0.9rem;
        background-color: #2c3034;
        color: #dee2e6;
        border-color: #495057;
    }
    #ingestionModal .form-control::placeholder {
        color: #6c757d;
    }
    #ingestion-progress-bar {
        height: 10px;
    }

    /* Settings Tab & RAG Tab Specific Styles */
    #settings-pane .form-label,
    #rag-pane-main .form-label {
        /* Target new main RAG pane */
        font-size: 0.9rem;
        color: #adb5bd;
    }
    #settings-pane .form-select,
    #settings-pane .form-control,
    #rag-pane-main .form-select,
    #rag-pane-main .form-control {
        background-color: #343a40;
        color: #dee2e6;
        border-color: #495057;
        font-size: 0.9rem;
    }
    #settings-pane .form-select:disabled,
    #settings-pane .form-control:disabled,
    #rag-pane-main .form-select:disabled,
    #rag-pane-main .form-control:disabled {
        background-color: #495057;
        opacity: 0.7;
    }
    #settings-pane .btn,
    #rag-pane-main .btn {
        font-size: 0.9rem;
    }
    #settings-pane h5,
    #settings-pane h6,
    #rag-pane-main h6 {
        color: #ced4da;
        margin-top: 1rem;
        margin-bottom: 0.75rem;
        border-bottom: 1px solid #495057;
        padding-bottom: 0.25rem;
    }

    /* RAG Inspector styling */
    #rag-retrieved-docs-display .list-group-item {
        background-color: #3a3f44;
        border-color: #495057;
        color: #dee2e6;
        padding: 0.5rem 0.75rem;
    }
    #rag-retrieved-docs-display h6 {
        color: #88c0d0; /* Nord cyan */
        margin-bottom: 0.25rem;
        border: none;
    }
    #rag-retrieved-docs-display pre {
        background-color: #2c3034;
        padding: 5px;
        border-radius: 3px;
        max-height: 80px;
        overflow-y: auto;
        font-size: 0.8em;
        white-space: pre-wrap;
        word-break: break-all;
    }
    #rag-retrieved-docs-display .rag-doc-actions .btn {
        font-size: 0.75rem;
    }

    /* Direct RAG Search Results Modal */
    #directRagSearchResultsModal .modal-body {
        font-size: 0.85rem;
    }
    #directRagSearchResultsModal .list-group-item {
        background-color: #3a3f44;
        border-color: #495057;
        color: #dee2e6;
        padding: 0.5rem 0.75rem;
    }
    #directRagSearchResultsModal .list-group-item strong {
        color: #88c0d0; /* Nord cyan for IDs/scores */
    }
    #directRagSearchResultsModal pre {
        background-color: #2c3034;
        padding: 5px;
        border-radius: 3px;
        max-height: 80px;
        overflow-y: auto;
        font-size: 0.8em;
        white-space: pre-wrap;
        word-break: break-all;
    }

    /* Prompt Template Values Table Styling */
    #prompt-values-table th,
    #prompt-values-table td {
        font-size: 0.85rem;
        vertical-align: middle;
    }
    #prompt-values-table .form-control-sm {
        font-size: 0.85rem; /* Ensure inputs are also small */
    }
    #prompt-values-table .btn-sm {
        padding: 0.2rem 0.4rem; /* Slightly smaller buttons */
        font-size: 0.75rem;
    }

    /* Prompt Workbench Styling */
    #prompt-workbench-textarea {
        background-color: #2c3034;
        color: #dee2e6;
        border-color: #495057;
        resize: vertical; /* Allow vertical resizing */
    }
</style>
{% endblock %} {% block body %}
<nav class="top-bar d-flex justify-content-between align-items-center">
    <div>
        <span class="llmchat-brand"
            >LLMChat Web
            <small id="app-version-display" class="text-muted"
                >v{{ app_version }}</small
            >
        </span>
    </div>
    <div class="d-flex">
        <span class="status-item"
            >Provider:
            <span id="status-provider" class="badge bg-secondary">N/A</span>
        </span>
        <span class="status-item"
            >Model:
            <span id="status-model" class="badge bg-secondary">N/A</span>
        </span>
        <span class="status-item"
            >RAG: <span id="status-rag" class="badge bg-danger">OFF</span></span
        >
        <span class="status-item"
            >Coworker:
            <span id="status-coworker" class="badge bg-danger">OFF</span>
        </span>
        <span class="status-item"
            >Context:
            <span id="status-context-usage" class="badge bg-info"
                >0/0 (0%)</span
            >
        </span>
    </div>
</nav>

<div class="main-layout flex-grow-1">
    <aside class="left-sidebar">
        <h5><i class="fas fa-comments"></i> Sessions</h5>
        <div class="btn-group w-100 mb-3" role="group">
            <button
                type="button"
                class="btn btn-primary btn-sm"
                id="btn-new-session"
            >
                <i class="fas fa-plus-circle"></i> New
            </button>
            <button
                type="button"
                class="btn btn-outline-secondary btn-sm"
                id="btn-delete-session"
                disabled
            >
                <i class="fas fa-trash-alt"></i> Delete
            </button>
        </div>
        <div id="session-list" class="list-group">
            <p class="text-muted small m-2">Loading sessions...</p>
        </div>
        <div class="mt-auto pt-2">
            <small class="text-muted"
                >LLMCore Status:
                <span id="llmcore-status-sidebar" class="badge bg-success"
                    >OK</span
                >
            </small>
        </div>
    </aside>

    <main class="main-content-area d-flex-fill-column">
        <ul class="nav nav-tabs px-2 pt-2" id="mainContentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button
                    class="nav-link active"
                    id="chat-tab-btn"
                    data-bs-toggle="tab"
                    data-bs-target="#chat-tab-pane"
                    type="button"
                    role="tab"
                    aria-controls="chat-tab-pane"
                    aria-selected="true"
                >
                    <i class="fas fa-comment-dots"></i> Chat
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button
                    class="nav-link"
                    id="context-manager-tab-btn"
                    data-bs-toggle="tab"
                    data-bs-target="#context-manager-tab-pane"
                    type="button"
                    role="tab"
                    aria-controls="context-manager-tab-pane"
                    aria-selected="false"
                >
                    <i class="fas fa-folder-open"></i> Context Manager
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button
                    class="nav-link"
                    id="rag-tab-main-btn"
                    data-bs-toggle="tab"
                    data-bs-target="#rag-pane-main"
                    type="button"
                    role="tab"
                    aria-controls="rag-pane-main"
                    aria-selected="false"
                >
                    <i class="fas fa-brain"></i> RAG
                </button>
            </li>
        </ul>
        <div
            class="tab-content flex-grow-1"
            id="mainContentTabsContent"
            style="overflow-y: hidden"
        >
            <div
                class="tab-pane fade show active tab-pane-full-height"
                id="chat-tab-pane"
                role="tabpanel"
                aria-labelledby="chat-tab-btn"
                tabindex="0"
            >
                <div id="chat-messages" class="flex-grow-1">
                    <div class="message-bubble agent-message">
                        Welcome to LLMChat Web! Start a new session or load an
                        existing one.
                    </div>
                </div>
            </div>
            <div
                class="tab-pane fade tab-pane-full-height"
                id="context-manager-tab-pane"
                role="tabpanel"
                aria-labelledby="context-manager-tab-btn"
                tabindex="0"
            >
                <!-- START: New Context Mode Toggle and UI containers -->
                <div class="d-flex justify-content-end align-items-center mb-2">
                    <div class="form-check form-switch">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            role="switch"
                            id="context-mode-toggle"
                        />
                        <label
                            class="form-check-label small"
                            for="context-mode-toggle"
                            >UI Managed Context</label
                        >
                    </div>
                </div>

                <!-- LLMCore Managed UI (default) -->
                <div id="llmcore-managed-context-ui" class="d-flex-fill-column">
                    <ul
                        class="nav nav-pills mb-3"
                        id="contextSubTabs"
                        role="tablist"
                    >
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link active"
                                id="workspace-subtab-btn"
                                data-bs-toggle="tab"
                                data-bs-target="#workspace-subtab-pane"
                                type="button"
                                role="tab"
                                aria-controls="workspace-subtab-pane"
                                aria-selected="true"
                            >
                                <i class="fas fa-briefcase"></i> Workspace &
                                Staging
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link"
                                id="history-subtab-btn"
                                data-bs-toggle="tab"
                                data-bs-target="#history-subtab-pane"
                                type="button"
                                role="tab"
                                aria-controls="history-subtab-pane"
                                aria-selected="false"
                            >
                                <i class="fas fa-history"></i> History Context
                            </button>
                        </li>
                    </ul>
                    <div
                        class="tab-content flex-grow-1"
                        id="contextSubTabsContent"
                    >
                        <div
                            class="tab-pane fade show active tab-pane-full-height"
                            id="workspace-subtab-pane"
                            role="tabpanel"
                            aria-labelledby="workspace-subtab-btn"
                        >
                            <!-- Original Two-Column Layout Goes Here -->
                            <div class="row h-100">
                                <div class="col-md-6 d-flex flex-column h-100">
                                    <h5>
                                        <i class="fas fa-briefcase"></i>
                                        Workspace Items (Context Pool)
                                    </h5>
                                    <div
                                        id="workspace-items-list"
                                        class="mb-3 border rounded p-2 flex-grow-1"
                                        style="overflow-y: auto"
                                    >
                                        <p class="text-muted p-2">
                                            Workspace items for the current
                                            session will appear here...
                                        </p>
                                    </div>
                                    <div class="mt-auto">
                                        <h6>
                                            <i class="fas fa-plus-circle"></i>
                                            Add Text Snippet
                                        </h6>
                                        <form
                                            id="form-add-text-snippet"
                                            class="mb-3"
                                        >
                                            <div class="mb-2">
                                                <label
                                                    for="text-snippet-content"
                                                    class="form-label form-label-sm"
                                                    >Content:</label
                                                >
                                                <textarea
                                                    class="form-control form-control-sm"
                                                    id="text-snippet-content"
                                                    rows="2"
                                                    required
                                                ></textarea>
                                            </div>
                                            <div class="mb-2">
                                                <label
                                                    for="text-snippet-id"
                                                    class="form-label form-label-sm"
                                                    >Optional Item ID:</label
                                                >
                                                <input
                                                    type="text"
                                                    class="form-control form-control-sm"
                                                    id="text-snippet-id"
                                                    placeholder="Auto-generated if blank"
                                                />
                                            </div>
                                            <button
                                                type="submit"
                                                class="btn btn-sm btn-success"
                                            >
                                                <i class="fas fa-plus"></i> Add
                                                Snippet
                                            </button>
                                        </form>
                                        <hr />
                                        <h6>
                                            <i class="fas fa-file-medical"></i>
                                            Add File by Server Path
                                        </h6>
                                        <form
                                            id="form-add-file-by-path"
                                            class="mb-2"
                                        >
                                            <div class="mb-2">
                                                <label
                                                    for="file-path-input"
                                                    class="form-label form-label-sm"
                                                    >Server File Path:</label
                                                >
                                                <input
                                                    type="text"
                                                    class="form-control form-control-sm"
                                                    id="file-path-input"
                                                    placeholder="/path/to/your/file_on_server.txt"
                                                    required
                                                />
                                            </div>
                                            <div class="mb-2">
                                                <label
                                                    for="file-item-id"
                                                    class="form-label form-label-sm"
                                                    >Optional Item ID:</label
                                                >
                                                <input
                                                    type="text"
                                                    class="form-control form-control-sm"
                                                    id="file-item-id"
                                                    placeholder="Auto-generated if blank"
                                                />
                                            </div>
                                            <button
                                                type="submit"
                                                class="btn btn-sm btn-success"
                                            >
                                                <i class="fas fa-plus"></i> Add
                                                File
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                <div class="col-md-6 d-flex flex-column h-100">
                                    <h5>
                                        <i class="fas fa-cogs"></i> Active
                                        Context Specification (for next prompt)
                                    </h5>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text"
                                            ><i class="fas fa-search"></i
                                        ></span>
                                        <input
                                            type="text"
                                            class="form-control form-control-sm"
                                            id="context-preview-query-input"
                                            placeholder="Optional: Type next query for more accurate preview..."
                                        />
                                    </div>
                                    <div
                                        id="active-context-spec-list"
                                        class="border rounded p-2 mb-2 flex-grow-1"
                                        style="overflow-y: auto"
                                    >
                                        <p class="text-muted p-2">
                                            Staged items for the next prompt
                                            will appear here. Add from
                                            Workspace, History, or create new.
                                        </p>
                                    </div>
                                    <div class="mt-auto">
                                        <p class="small text-muted">
                                            Add to Active Context:
                                        </p>
                                        <div
                                            class="btn-group w-100 mb-2"
                                            role="group"
                                        >
                                            <button
                                                class="btn btn-sm btn-outline-primary"
                                                id="btn-stage-from-workspace"
                                                title="Select from Workspace Items"
                                            >
                                                <i class="fas fa-briefcase"></i>
                                                Workspace
                                            </button>
                                            <button
                                                class="btn btn-sm btn-outline-primary"
                                                id="btn-stage-from-history"
                                                title="Select from Chat History"
                                            >
                                                <i class="fas fa-history"></i>
                                                History
                                            </button>
                                            <button
                                                class="btn btn-sm btn-outline-primary"
                                                id="btn-stage-new-file"
                                                title="Add a new file by path"
                                            >
                                                <i class="fas fa-file-alt"></i>
                                                New File
                                            </button>
                                            <button
                                                class="btn btn-sm btn-outline-primary"
                                                id="btn-stage-new-text"
                                                title="Add a new text snippet"
                                            >
                                                <i
                                                    class="fas fa-file-signature"
                                                ></i>
                                                New Text
                                            </button>
                                        </div>
                                        <button
                                            class="btn btn-sm btn-info w-100"
                                            id="btn-preview-full-context"
                                        >
                                            <i class="fas fa-eye"></i> Preview
                                            Full Context for Next Prompt
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div
                            class="tab-pane fade tab-pane-full-height"
                            id="history-subtab-pane"
                            role="tabpanel"
                            aria-labelledby="history-subtab-btn"
                        >
                            <!-- New UI for History Context Management -->
                            <h5>
                                <i class="fas fa-history"></i> Conversation
                                History Context
                            </h5>
                            <p class="small text-muted">
                                Select messages to include in the next prompt's
                                context. Unchecked messages will be excluded.
                            </p>
                            <div id="history-context-toolbar" class="mb-2">
                                <div
                                    class="btn-group btn-group-sm"
                                    role="group"
                                    aria-label="History context tools"
                                >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="history-context-select-all"
                                    >
                                        <i class="fas fa-check-double"></i>
                                        Select All
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="history-context-deselect-all"
                                    >
                                        <i class="far fa-square"></i> Deselect
                                        All
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="history-context-invert"
                                    >
                                        <i class="fas fa-retweet"></i> Invert
                                    </button>
                                </div>
                            </div>
                            <div
                                id="history-context-message-list"
                                class="border rounded p-2 flex-grow-1"
                                style="overflow-y: auto"
                            >
                                <p class="text-muted p-2">
                                    Load a session to manage its history
                                    context...
                                </p>
                            </div>
                            <div class="mt-2">
                                <button
                                    class="btn btn-primary btn-sm"
                                    id="btn-save-context-selection"
                                >
                                    <i class="fas fa-save"></i> Save Context
                                    Selection
                                </button>
                                <small class="text-muted ms-2"
                                    >Selection is saved to the session's
                                    metadata.</small
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UI Managed UI (hidden by default) -->
                <div
                    id="ui-managed-context-ui"
                    class="d-flex flex-column h-100"
                    style="display: none"
                >
                    <h5>
                        <i class="fas fa-edit"></i> Prompt Workbench (UI
                        Managed)
                    </h5>
                    <p class="small text-muted">
                        In this mode, the text below is sent directly to the
                        LLM, bypassing LLMCore's context assembly. Your message
                        from the main chat input will still be saved to history.
                    </p>
                    <textarea
                        id="prompt-workbench-textarea"
                        class="form-control flex-grow-1"
                        style="font-family: monospace; font-size: 0.9em"
                        placeholder="Enter your full, raw prompt here..."
                    ></textarea>
                    <div
                        id="prompt-workbench-token-count"
                        class="text-end text-muted small mt-1"
                    >
                        Tokens: 0
                    </div>
                </div>
                <!-- END: New Context Mode Toggle and UI containers -->
            </div>
            <div
                class="tab-pane fade"
                id="rag-pane-main"
                role="tabpanel"
                aria-labelledby="rag-tab-main-btn"
                tabindex="0"
            >
                <h6><i class="fas fa-cogs"></i> RAG Configuration</h6>
                <form id="rag-controls-form">
                    <div class="row g-2 align-items-center">
                        <div class="col-auto">
                            <div class="form-check form-switch">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    role="switch"
                                    id="rag-toggle-switch"
                                />
                                <label
                                    class="form-check-label small"
                                    for="rag-toggle-switch"
                                    >Enable RAG</label
                                >
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label
                                for="rag-collection-select"
                                class="form-label form-label-sm visually-hidden"
                                >RAG Collection</label
                            >
                            <select
                                class="form-select form-select-sm"
                                id="rag-collection-select"
                                aria-label="Select RAG Collection"
                                disabled
                            >
                                <option selected value="">
                                    Select Collection...
                                </option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label
                                for="rag-k-value"
                                class="form-label form-label-sm visually-hidden"
                                >K Value</label
                            >
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">K:</span>
                                <input
                                    type="number"
                                    class="form-control"
                                    id="rag-k-value"
                                    value="3"
                                    min="1"
                                    max="20"
                                    disabled
                                />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label
                                for="rag-filter-input"
                                class="form-label form-label-sm visually-hidden"
                                >Metadata Filter</label
                            >
                            <input
                                type="text"
                                class="form-control form-control-sm"
                                id="rag-filter-input"
                                placeholder="Metadata Filter (JSON)..."
                                disabled
                            />
                        </div>
                        <div class="col-auto">
                            <button
                                type="button"
                                class="btn btn-sm btn-success"
                                id="btn-ingest-data"
                                title="Ingest new data into a RAG collection"
                            >
                                <i class="fas fa-database"></i> Ingest Data
                            </button>
                        </div>
                    </div>
                </form>

                <hr class="my-3" />
                <h6><i class="fas fa-search"></i> Direct RAG Search</h6>
                <form id="direct-rag-search-form">
                    <div class="input-group input-group-sm mb-2">
                        <input
                            type="text"
                            class="form-control"
                            id="direct-rag-search-query"
                            placeholder="Enter search query..."
                            required
                        />
                        <button
                            class="btn btn-info"
                            type="submit"
                            id="btn-direct-rag-search"
                        >
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </form>
                <p class="small text-muted mt-1">
                    Uses current RAG settings (collection, K, filter) for the
                    search. Results will appear in a modal.
                </p>

                <!-- Start: New RAG Results Display Area -->
                <hr class="my-3" />
                <h6>
                    <i class="fas fa-book-open"></i> Retrieved Documents for
                    Last Chat
                </h6>
                <div
                    id="rag-retrieved-docs-display"
                    class="border rounded p-2 d-none"
                    style="max-height: 250px; overflow-y: auto"
                >
                    <p class="text-muted small">
                        After a RAG-enabled chat, retrieved documents will be
                        displayed here.
                    </p>
                </div>
                <!-- End: New RAG Results Display Area -->
            </div>
        </div>
    </main>
</div>

<nav class="bottom-control-bar">
    <ul class="nav nav-tabs nav-fill" id="bottomControlTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button
                class="nav-link active"
                id="chat-input-tab-btn"
                data-bs-toggle="tab"
                data-bs-target="#chat-input-pane"
                type="button"
                role="tab"
                aria-controls="chat-input-pane"
                aria-selected="true"
            >
                <i class="fas fa-keyboard"></i> Chat Input
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="settings-tab-btn"
                data-bs-toggle="tab"
                data-bs-target="#settings-pane"
                type="button"
                role="tab"
                aria-controls="settings-pane"
                aria-selected="false"
            >
                <i class="fas fa-cog"></i> Settings
            </button>
        </li>
    </ul>
    <div class="tab-content" id="bottomControlTabsContent">
        <div
            class="tab-pane fade show active"
            id="chat-input-pane"
            role="tabpanel"
            aria-labelledby="chat-input-tab-btn"
            tabindex="0"
        >
            <div id="chat-input-area">
                <div class="input-group">
                    <textarea
                        class="form-control"
                        id="chat-input"
                        rows="3"
                        placeholder="Type your message..."
                    ></textarea>
                    <button
                        class="btn btn-primary"
                        type="button"
                        id="send-chat-message"
                    >
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
                <div class="mt-1 text-end">
                    <small class="text-muted" id="chat-input-token-estimate"
                        >Tokens: 0</small
                    >
                </div>
            </div>
        </div>
        <div
            class="tab-pane fade p-2"
            id="settings-pane"
            role="tabpanel"
            aria-labelledby="settings-tab-btn"
            tabindex="0"
        >
            <h5><i class="fas fa-robot"></i> LLM Configuration</h5>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="llm-provider-select" class="form-label"
                        >Provider:</label
                    >
                    <select
                        class="form-select"
                        id="llm-provider-select"
                        aria-label="Select LLM Provider"
                    >
                        <option selected value="">Loading providers...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="llm-model-select" class="form-label"
                        >Model:</label
                    >
                    <select
                        class="form-select"
                        id="llm-model-select"
                        aria-label="Select LLM Model"
                        disabled
                    >
                        <option selected value="">Select provider first</option>
                    </select>
                </div>
            </div>
            <button
                type="button"
                class="btn btn-primary btn-sm mb-3"
                id="btn-apply-llm-settings"
            >
                <i class="fas fa-check-circle"></i> Apply LLM Settings
            </button>

            <hr class="my-3" />

            <h5><i class="fas fa-user-cog"></i> System Message</h5>
            <div class="mb-3">
                <label for="system-message-input" class="form-label"
                    >Set System Message for current session:</label
                >
                <textarea
                    class="form-control"
                    id="system-message-input"
                    rows="3"
                    placeholder="e.g., You are a helpful assistant specializing in Python programming."
                ></textarea>
            </div>
            <button
                type="button"
                class="btn btn-primary btn-sm mb-3"
                id="btn-apply-system-message"
            >
                <i class="fas fa-save"></i> Apply System Message
            </button>

            <hr class="my-3" />
            <h6>
                <i class="fas fa-file-code"></i> Prompt Template Values (RAG)
            </h6>
            <p class="small text-muted">
                Define custom key-value pairs for placeholders (e.g.,
                <code>{my_key}</code>) in your RAG prompt template.
            </p>
            <div
                class="table-responsive mb-2"
                style="max-height: 200px; overflow-y: auto"
            >
                <table
                    class="table table-sm table-dark table-striped table-hover"
                    id="prompt-values-table"
                >
                    <thead>
                        <tr>
                            <th scope="col" style="width: 35%">Key</th>
                            <th scope="col" style="width: 45%">Value</th>
                            <th scope="col" style="width: 20%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="prompt-values-tbody">
                        <tr>
                            <td colspan="3" class="text-center text-muted">
                                No prompt values set.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <form
                id="form-add-prompt-value"
                class="row gx-2 gy-2 align-items-end mb-2"
            >
                <div class="col-md-4">
                    <label
                        for="new-prompt-key"
                        class="form-label form-label-sm visually-hidden"
                        >New Key</label
                    >
                    <input
                        type="text"
                        class="form-control form-control-sm"
                        id="new-prompt-key"
                        placeholder="Enter Key"
                        required
                    />
                </div>
                <div class="col-md-5">
                    <label
                        for="new-prompt-value"
                        class="form-label form-label-sm visually-hidden"
                        >New Value</label
                    >
                    <input
                        type="text"
                        class="form-control form-control-sm"
                        id="new-prompt-value"
                        placeholder="Enter Value"
                        required
                    />
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success btn-sm w-100">
                        <i class="fas fa-plus"></i> Add Value
                    </button>
                </div>
            </form>
            <button
                type="button"
                class="btn btn-danger btn-sm"
                id="btn-clear-all-prompt-values"
            >
                <i class="fas fa-trash-alt"></i> Clear All Values
            </button>
            <hr class="my-3" />
            <button
                type="button"
                class="btn btn-secondary btn-sm"
                id="btn-view-app-logs"
            >
                <i class="fas fa-stream"></i> View Application Logs
            </button>
        </div>
    </div>
</nav>

<!-- Modals -->
<div
    class="modal fade"
    id="viewItemContentModal"
    tabindex="-1"
    aria-labelledby="viewItemContentModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="viewItemContentModalLabel">
                    Item Content
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <pre
                    id="modalItemContentDisplay"
                    style="white-space: pre-wrap; word-wrap: break-word"
                ></pre>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade"
    id="contextPreviewModal"
    tabindex="-1"
    aria-labelledby="contextPreviewModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="contextPreviewModalLabel">
                    <i class="fas fa-search-plus"></i> Full Context Preview
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div
                class="modal-body"
                id="modalContextPreviewDisplay"
                style="font-size: 0.85rem"
            >
                <p class="text-muted">Loading context preview...</p>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade"
    id="ingestionModal"
    tabindex="-1"
    aria-labelledby="ingestionModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="ingestionModalLabel">
                    <i class="fas fa-upload"></i> Ingest Data for RAG
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <ul
                    class="nav nav-tabs mb-3"
                    id="ingestionTypeTabs"
                    role="tablist"
                >
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link active"
                            id="ingest-file-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#ingest-file-pane"
                            type="button"
                            role="tab"
                            aria-controls="ingest-file-pane"
                            aria-selected="true"
                        >
                            <i class="fas fa-file-alt"></i> Upload File(s)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link"
                            id="ingest-dir-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#ingest-dir-pane"
                            type="button"
                            role="tab"
                            aria-controls="ingest-dir-pane"
                            aria-selected="false"
                        >
                            <i class="fas fa-folder-open"></i> Upload Directory
                            (ZIP)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link"
                            id="ingest-git-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#ingest-git-pane"
                            type="button"
                            role="tab"
                            aria-controls="ingest-git-pane"
                            aria-selected="false"
                        >
                            <i class="fab fa-git-alt"></i> Git Repository URL
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="ingestionTypeTabsContent">
                    <div
                        class="tab-pane fade show active"
                        id="ingest-file-pane"
                        role="tabpanel"
                        aria-labelledby="ingest-file-tab"
                    >
                        <form id="form-ingest-file">
                            <div class="mb-3">
                                <label
                                    for="ingest-file-input"
                                    class="form-label"
                                    >Select File(s):</label
                                >
                                <input
                                    class="form-control"
                                    type="file"
                                    id="ingest-file-input"
                                    multiple
                                />
                                <small class="form-text text-muted"
                                    >Select one or more files to ingest.</small
                                >
                            </div>
                            <div class="mb-3">
                                <label
                                    for="ingest-file-collection"
                                    class="form-label"
                                    >Target Collection Name:</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-file-collection"
                                    placeholder="e.g., project_docs_alpha"
                                    required
                                />
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-arrow-circle-up"></i> Start
                                File Ingestion
                            </button>
                        </form>
                    </div>
                    <div
                        class="tab-pane fade"
                        id="ingest-dir-pane"
                        role="tabpanel"
                        aria-labelledby="ingest-dir-tab"
                    >
                        <form id="form-ingest-dir">
                            <div class="mb-3">
                                <label
                                    for="ingest-dir-zip-input"
                                    class="form-label"
                                    >Select Directory ZIP File:</label
                                >
                                <input
                                    class="form-control"
                                    type="file"
                                    id="ingest-dir-zip-input"
                                    accept=".zip"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label
                                    for="ingest-dir-collection"
                                    class="form-label"
                                    >Target Collection Name:</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-dir-collection"
                                    placeholder="e.g., my_codebase_snapshot"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label
                                    for="ingest-dir-repo-name"
                                    class="form-label"
                                    >Repository/Directory Identifier
                                    (Optional):</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-dir-repo-name"
                                    placeholder="e.g., MyProjectV1"
                                />
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-archive"></i> Start Directory
                                Ingestion
                            </button>
                        </form>
                    </div>
                    <div
                        class="tab-pane fade"
                        id="ingest-git-pane"
                        role="tabpanel"
                        aria-labelledby="ingest-git-tab"
                    >
                        <form id="form-ingest-git">
                            <div class="mb-3">
                                <label for="ingest-git-url" class="form-label"
                                    >Git Repository URL:</label
                                >
                                <input
                                    type="url"
                                    class="form-control"
                                    id="ingest-git-url"
                                    placeholder="https://github.com/user/repo.git"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label
                                    for="ingest-git-collection"
                                    class="form-label"
                                    >Target Collection Name:</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-git-collection"
                                    placeholder="e.g., open_source_project_main"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label
                                    for="ingest-git-repo-name"
                                    class="form-label"
                                    >Repository Identifier:</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-git-repo-name"
                                    placeholder="e.g., LLMCoreProject"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label for="ingest-git-ref" class="form-label"
                                    >Branch/Tag/Commit (Optional):</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-git-ref"
                                    placeholder="e.g., main, v1.0.2, abc1234 (defaults to HEAD)"
                                />
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fab fa-git-square"></i> Start Git
                                Ingestion
                            </button>
                        </form>
                    </div>
                </div>
                <hr />
                <div id="ingestion-status-area" class="mt-3">
                    <p class="small text-muted">
                        Ingestion progress will appear here...
                    </p>
                    <div
                        class="progress"
                        style="height: 10px; display: none"
                        id="ingestion-progress-container"
                    >
                        <div
                            class="progress-bar progress-bar-striped progress-bar-animated"
                            id="ingestion-progress-bar"
                            role="progressbar"
                            style="width: 0%"
                            aria-valuenow="0"
                            aria-valuemin="0"
                            aria-valuemax="100"
                        ></div>
                    </div>
                    <div id="ingestion-result-message" class="mt-2 small"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade"
    id="directRagSearchResultsModal"
    tabindex="-1"
    aria-labelledby="directRagSearchResultsModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="directRagSearchResultsModalLabel">
                    <i class="fas fa-search-location"></i> Direct RAG Search
                    Results
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body" id="directRagSearchResultsBody">
                <p class="text-muted">Search results will appear here...</p>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade"
    id="appLogsModal"
    tabindex="-1"
    aria-labelledby="appLogsModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="appLogsModalLabel">
                    <i class="fas fa-align-left"></i> Application Logs
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <pre
                    id="app-logs-display"
                    style="
                        max-height: 60vh;
                        overflow-y: auto;
                        font-size: 0.8rem;
                        background-color: #212529;
                        padding: 10px;
                        border-radius: 5px;
                    "
                >
Loading logs...</pre
                >
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
    id="toast-container"
    class="toast-container position-fixed top-0 end-0 p-3"
    style="z-index: 1056"
></div>

{% endblock %} {% block scripts_extra %}
<script>
    // Basic tab functionality
    document.addEventListener("DOMContentLoaded", function () {
        var triggerTabList = [].slice.call(
            document.querySelectorAll(
                "#mainContentTabs button, #bottomControlTabs button, #ingestionTypeTabs button, #contextSubTabs button",
            ),
        );
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl);
            triggerEl.addEventListener("click", function (event) {
                event.preventDefault();
                tabTrigger.show();
            });
        });
    });
</script>
{% endblock %}
