{% extends "layout.html" %} {% block title %}LLMChat Web REPL{% endblock %} {%
block head_extra %}
<!--
  The <style> block that was previously here has been removed.
  All custom CSS rules have been migrated to the external stylesheet:
  /static/css/custom.css
  This change is part of the refactoring effort to support switchable theming.
-->
{% endblock %} {% block body %}
<nav class="top-bar d-flex justify-content-between align-items-center">
    <div>
        <span class="llmchat-brand"
            >LLMChat Web
            <small id="app-version-display" class="text-muted"
                >v{{ app_version }}</small
            >
        </span>
    </div>
    <div class="d-flex align-items-center">
        <span class="status-item"
            >Provider:
            <span id="status-provider" class="badge bg-secondary">N/A</span>
        </span>
        <span class="status-item"
            >Model:
            <span id="status-model" class="badge bg-secondary">N/A</span>
        </span>
        <span class="status-item"
            >RAG: <span id="status-rag" class="badge bg-danger">OFF</span></span
        >
        <span class="status-item"
            >Coworker:
            <span id="status-coworker" class="badge bg-danger">OFF</span>
        </span>
        <span class="status-item"
            >Context:
            <span id="status-context-usage" class="badge bg-info"
                >0/0 (0%)</span
            >
        </span>
        <!-- START: Theme Switcher Dropdown -->
        <div class="dropdown ms-2">
            <button
                class="btn btn-sm btn-outline-secondary dropdown-toggle"
                type="button"
                id="theme-switcher-btn"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                title="Change Theme"
            >
                <i class="fas fa-palette"></i>
            </button>
            <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="theme-switcher-btn"
            >
                <li>
                    <a class="dropdown-item" href="#" data-theme="dark"
                        ><i class="fas fa-moon me-2"></i>Dark</a
                    >
                </li>
                <li>
                    <a class="dropdown-item" href="#" data-theme="light"
                        ><i class="fas fa-sun me-2"></i>Light</a
                    >
                </li>
            </ul>
        </div>
        <!-- END: Theme Switcher Dropdown -->
    </div>
</nav>

<div class="main-layout flex-grow-1">
    <aside class="left-sidebar">
        <h5><i class="fas fa-comments"></i> Sessions</h5>
        <div class="btn-group w-100 mb-3" role="group">
            <button
                type="button"
                class="btn btn-primary btn-sm"
                id="btn-new-session"
            >
                <i class="fas fa-plus-circle"></i> New Session
            </button>
        </div>
        <div id="session-list" class="list-group">
            <p class="text-muted small m-2">Loading sessions...</p>
        </div>
        <div class="mt-auto pt-2">
            <small class="text-muted"
                >LLMCore Status:
                <span id="llmcore-status-sidebar" class="badge bg-success"
                    >OK</span
                >
            </small>
        </div>
    </aside>

    <main class="main-content-area d-flex-fill-column">
        <ul class="nav nav-tabs px-2 pt-2" id="mainContentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button
                    class="nav-link active"
                    id="chat-tab-btn"
                    data-bs-toggle="tab"
                    data-bs-target="#chat-tab-pane"
                    type="button"
                    role="tab"
                    aria-controls="chat-tab-pane"
                    aria-selected="true"
                >
                    <i class="fas fa-comment-dots"></i> Chat
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button
                    class="nav-link"
                    id="context-manager-tab-btn"
                    data-bs-toggle="tab"
                    data-bs-target="#context-manager-tab-pane"
                    type="button"
                    role="tab"
                    aria-controls="context-manager-tab-pane"
                    aria-selected="false"
                >
                    <i class="fas fa-folder-open"></i> Context Manager
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button
                    class="nav-link"
                    id="rag-tab-main-btn"
                    data-bs-toggle="tab"
                    data-bs-target="#rag-pane-main"
                    type="button"
                    role="tab"
                    aria-controls="rag-pane-main"
                    aria-selected="false"
                >
                    <i class="fas fa-brain"></i> RAG
                </button>
            </li>
        </ul>
        <div
            class="tab-content flex-grow-1"
            id="mainContentTabsContent"
            style="overflow-y: hidden"
        >
            <div
                class="tab-pane fade show active tab-pane-full-height"
                id="chat-tab-pane"
                role="tabpanel"
                aria-labelledby="chat-tab-btn"
                tabindex="0"
            >
                <div id="chat-messages" class="flex-grow-1">
                    <div class="message-bubble agent-message">
                        Welcome to LLMChat Web! Start a new session or load an
                        existing one.
                    </div>
                </div>
            </div>
            <div
                class="tab-pane fade tab-pane-full-height"
                id="context-manager-tab-pane"
                role="tabpanel"
                aria-labelledby="context-manager-tab-btn"
                tabindex="0"
            >
                <!-- START: New Context Mode Toggle and UI containers -->
                <div class="d-flex justify-content-end align-items-center mb-2">
                    <div class="form-check form-switch">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            role="switch"
                            id="context-mode-toggle"
                        />
                        <label
                            class="form-check-label small"
                            for="context-mode-toggle"
                            >UI Managed Context</label
                        >
                    </div>
                </div>

                <!-- LLMCore Managed UI (default) -->
                <div id="llmcore-managed-context-ui" class="d-flex-fill-column">
                    <ul
                        class="nav nav-pills mb-3"
                        id="contextSubTabs"
                        role="tablist"
                    >
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link active"
                                id="workspace-subtab-btn"
                                data-bs-toggle="tab"
                                data-bs-target="#workspace-subtab-pane"
                                type="button"
                                role="tab"
                                aria-controls="workspace-subtab-pane"
                                aria-selected="true"
                            >
                                <i class="fas fa-briefcase"></i> Workspace &
                                Staging
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link"
                                id="history-subtab-btn"
                                data-bs-toggle="tab"
                                data-bs-target="#history-subtab-pane"
                                type="button"
                                role="tab"
                                aria-controls="history-subtab-pane"
                                aria-selected="false"
                            >
                                <i class="fas fa-history"></i> History Context
                            </button>
                        </li>
                    </ul>
                    <div
                        class="tab-content flex-grow-1"
                        id="contextSubTabsContent"
                    >
                        <div
                            class="tab-pane fade show active tab-pane-full-height"
                            id="workspace-subtab-pane"
                            role="tabpanel"
                            aria-labelledby="workspace-subtab-btn"
                        >
                            <!-- Original Two-Column Layout Goes Here -->
                            <div class="row h-100">
                                <div class="col-md-6 d-flex flex-column h-100">
                                    <h5>
                                        <i class="fas fa-briefcase"></i>
                                        Workspace Items (Context Pool)
                                    </h5>
                                    <div
                                        id="workspace-items-list"
                                        class="mb-3 border rounded p-2 flex-grow-1"
                                        style="overflow-y: auto"
                                    >
                                        <p class="text-muted p-2">
                                            Workspace items for the current
                                            session will appear here...
                                        </p>
                                    </div>
                                    <div class="mt-auto">
                                        <h6>
                                            <i class="fas fa-plus-circle"></i>
                                            Add Text Snippet
                                        </h6>
                                        <form
                                            id="form-add-text-snippet"
                                            class="mb-3"
                                        >
                                            <div class="mb-2">
                                                <label
                                                    for="text-snippet-content"
                                                    class="form-label form-label-sm"
                                                    >Content:</label
                                                >
                                                <textarea
                                                    class="form-control form-control-sm"
                                                    id="text-snippet-content"
                                                    rows="2"
                                                    required
                                                ></textarea>
                                            </div>
                                            <div class="mb-2">
                                                <label
                                                    for="text-snippet-id"
                                                    class="form-label form-label-sm"
                                                    >Optional Item ID:</label
                                                >
                                                <input
                                                    type="text"
                                                    class="form-control form-control-sm"
                                                    id="text-snippet-id"
                                                    placeholder="Auto-generated if blank"
                                                />
                                            </div>
                                            <button
                                                type="submit"
                                                class="btn btn-sm btn-success"
                                            >
                                                <i class="fas fa-plus"></i> Add
                                                Snippet
                                            </button>
                                        </form>
                                        <hr />
                                        <h6>
                                            <i class="fas fa-file-medical"></i>
                                            Add File by Server Path
                                        </h6>
                                        <form
                                            id="form-add-file-by-path"
                                            class="mb-2"
                                        >
                                            <div class="mb-2">
                                                <label
                                                    for="file-path-input"
                                                    class="form-label form-label-sm"
                                                    >Server File Path:</label
                                                >
                                                <input
                                                    type="text"
                                                    class="form-control form-control-sm"
                                                    id="file-path-input"
                                                    placeholder="/path/to/your/file_on_server.txt"
                                                    required
                                                />
                                            </div>
                                            <div class="mb-2">
                                                <label
                                                    for="file-item-id"
                                                    class="form-label form-label-sm"
                                                    >Optional Item ID:</label
                                                >
                                                <input
                                                    type="text"
                                                    class="form-control form-control-sm"
                                                    id="file-item-id"
                                                    placeholder="Auto-generated if blank"
                                                />
                                            </div>
                                            <button
                                                type="submit"
                                                class="btn btn-sm btn-success"
                                            >
                                                <i class="fas fa-plus"></i> Add
                                                File
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                <div class="col-md-6 d-flex flex-column h-100">
                                    <h5>
                                        <i class="fas fa-cogs"></i> Active
                                        Context Specification (for next prompt)
                                    </h5>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text"
                                            ><i class="fas fa-search"></i
                                        ></span>
                                        <input
                                            type="text"
                                            class="form-control form-control-sm"
                                            id="context-preview-query-input"
                                            placeholder="Optional: Type next query for more accurate preview..."
                                        />
                                    </div>
                                    <div
                                        id="active-context-spec-list"
                                        class="border rounded p-2 mb-2 flex-grow-1"
                                        style="overflow-y: auto"
                                    >
                                        <p class="text-muted p-2">
                                            Staged items for the next prompt
                                            will appear here. Add from
                                            Workspace, History, or create new.
                                        </p>
                                    </div>
                                    <div class="mt-auto">
                                        <p class="small text-muted">
                                            Add to Active Context:
                                        </p>
                                        <div
                                            class="btn-group w-100 mb-2"
                                            role="group"
                                        >
                                            <button
                                                class="btn btn-sm btn-outline-primary"
                                                id="btn-stage-from-workspace"
                                                title="Select from Workspace Items"
                                            >
                                                <i class="fas fa-briefcase"></i>
                                                Workspace
                                            </button>
                                            <button
                                                class="btn btn-sm btn-outline-primary"
                                                id="btn-stage-from-history"
                                                title="Select from Chat History"
                                            >
                                                <i class="fas fa-history"></i>
                                                History
                                            </button>
                                            <button
                                                class="btn btn-sm btn-outline-primary"
                                                id="btn-stage-new-file"
                                                title="Add a new file by path"
                                            >
                                                <i class="fas fa-file-alt"></i>
                                                New File
                                            </button>
                                            <button
                                                class="btn btn-sm btn-outline-primary"
                                                id="btn-stage-new-text"
                                                title="Add a new text snippet"
                                            >
                                                <i
                                                    class="fas fa-file-signature"
                                                ></i>
                                                New Text
                                            </button>
                                        </div>
                                        <button
                                            class="btn btn-sm btn-info w-100"
                                            id="btn-preview-full-context"
                                        >
                                            <i class="fas fa-eye"></i> Preview
                                            Full Context for Next Prompt
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div
                            class="tab-pane fade tab-pane-full-height"
                            id="history-subtab-pane"
                            role="tabpanel"
                            aria-labelledby="history-subtab-btn"
                        >
                            <!-- New UI for History Context Management -->
                            <h5>
                                <i class="fas fa-history"></i> Conversation
                                History Context
                            </h5>
                            <p class="small text-muted">
                                Select messages to include in the next prompt's
                                context. Unchecked messages will be excluded.
                            </p>
                            <div id="history-context-toolbar" class="mb-2">
                                <div
                                    class="btn-group btn-group-sm"
                                    role="group"
                                    aria-label="History context tools"
                                >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="history-context-select-all"
                                    >
                                        <i class="fas fa-check-double"></i>
                                        Select All
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="history-context-deselect-all"
                                    >
                                        <i class="far fa-square"></i> Deselect
                                        All
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="history-context-invert"
                                    >
                                        <i class="fas fa-retweet"></i> Invert
                                    </button>
                                </div>
                            </div>
                            <div
                                id="history-context-message-list"
                                class="border rounded p-2 flex-grow-1"
                                style="overflow-y: auto"
                            >
                                <p class="text-muted p-2">
                                    Load a session to manage its history
                                    context...
                                </p>
                            </div>
                            <div class="mt-2">
                                <button
                                    class="btn btn-primary btn-sm"
                                    id="btn-save-context-selection"
                                >
                                    <i class="fas fa-save"></i> Save Context
                                    Selection
                                </button>
                                <small class="text-muted ms-2"
                                    >Selection is saved to the session's
                                    metadata.</small
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UI Managed UI (hidden by default) -->
                <div
                    id="ui-managed-context-ui"
                    class="d-flex flex-column h-100"
                    style="display: none"
                >
                    <h5>
                        <i class="fas fa-edit"></i> Prompt Workbench (UI
                        Managed)
                    </h5>
                    <p class="small text-muted">
                        In this mode, the text below is sent directly to the
                        LLM, bypassing LLMCore's context assembly. Your message
                        from the main chat input will still be saved to history.
                    </p>
                    <textarea
                        id="prompt-workbench-textarea"
                        class="form-control flex-grow-1"
                        style="font-family: monospace; font-size: 0.9em"
                        placeholder="Enter your full, raw prompt here..."
                    ></textarea>
                    <div
                        id="prompt-workbench-token-count"
                        class="text-end text-muted small mt-1"
                    >
                        Tokens: 0
                    </div>
                </div>
                <!-- END: New Context Mode Toggle and UI containers -->
            </div>
            <div
                class="tab-pane fade"
                id="rag-pane-main"
                role="tabpanel"
                aria-labelledby="rag-tab-main-btn"
                tabindex="0"
            >
                <h6><i class="fas fa-cogs"></i> RAG Configuration</h6>
                <form id="rag-controls-form">
                    <div class="row g-2 align-items-center">
                        <div class="col-auto">
                            <div class="form-check form-switch">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    role="switch"
                                    id="rag-toggle-switch"
                                />
                                <label
                                    class="form-check-label small"
                                    for="rag-toggle-switch"
                                    >Enable RAG</label
                                >
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label
                                for="rag-collection-select"
                                class="form-label form-label-sm visually-hidden"
                                >RAG Collection</label
                            >
                            <select
                                class="form-select form-select-sm"
                                id="rag-collection-select"
                                aria-label="Select RAG Collection"
                                disabled
                            >
                                <option selected value="">
                                    Select Collection...
                                </option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label
                                for="rag-k-value"
                                class="form-label form-label-sm visually-hidden"
                                >K Value</label
                            >
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">K:</span>
                                <input
                                    type="number"
                                    class="form-control"
                                    id="rag-k-value"
                                    value="3"
                                    min="1"
                                    max="20"
                                    disabled
                                />
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label
                                for="rag-filter-input"
                                class="form-label form-label-sm visually-hidden"
                                >Metadata Filter</label
                            >
                            <input
                                type="text"
                                class="form-control form-control-sm"
                                id="rag-filter-input"
                                placeholder="Metadata Filter (JSON)..."
                                disabled
                            />
                        </div>
                        <div class="col-auto">
                            <button
                                type="button"
                                class="btn btn-sm btn-success"
                                id="btn-ingest-data"
                                title="Ingest new data into a RAG collection"
                            >
                                <i class="fas fa-database"></i> Ingest Data
                            </button>
                        </div>
                    </div>
                </form>

                <hr class="my-3" />
                <h6><i class="fas fa-search"></i> Direct RAG Search</h6>
                <form id="direct-rag-search-form">
                    <div class="input-group input-group-sm mb-2">
                        <input
                            type="text"
                            class="form-control"
                            id="direct-rag-search-query"
                            placeholder="Enter search query..."
                            required
                        />
                        <button
                            class="btn btn-info"
                            type="submit"
                            id="btn-direct-rag-search"
                        >
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </form>
                <p class="small text-muted mt-1">
                    Uses current RAG settings (collection, K, filter) for the
                    search. Results will appear in a modal.
                </p>

                <!-- Start: New RAG Results Display Area -->
                <hr class="my-3" />
                <h6>
                    <i class="fas fa-book-open"></i> Retrieved Documents for
                    Last Chat
                </h6>
                <div
                    id="rag-retrieved-docs-display"
                    class="border rounded p-2 d-none"
                    style="max-height: 250px; overflow-y: auto"
                >
                    <p class="text-muted small">
                        After a RAG-enabled chat, retrieved documents will be
                        displayed here.
                    </p>
                </div>
                <!-- End: New RAG Results Display Area -->
            </div>
        </div>
    </main>
</div>

<nav class="bottom-control-bar">
    <ul class="nav nav-tabs nav-fill" id="bottomControlTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button
                class="nav-link active"
                id="chat-input-tab-btn"
                data-bs-toggle="tab"
                data-bs-target="#chat-input-pane"
                type="button"
                role="tab"
                aria-controls="chat-input-pane"
                aria-selected="true"
            >
                <i class="fas fa-keyboard"></i> Chat Input
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="settings-tab-btn"
                data-bs-toggle="tab"
                data-bs-target="#settings-pane"
                type="button"
                role="tab"
                aria-controls="settings-pane"
                aria-selected="false"
            >
                <i class="fas fa-cog"></i> Settings
            </button>
        </li>
    </ul>
    <div class="tab-content" id="bottomControlTabsContent">
        <div
            class="tab-pane fade show active"
            id="chat-input-pane"
            role="tabpanel"
            aria-labelledby="chat-input-tab-btn"
            tabindex="0"
        >
            <div id="chat-input-area">
                <div class="input-group">
                    <textarea
                        class="form-control"
                        id="chat-input"
                        rows="3"
                        placeholder="Type your message..."
                    ></textarea>
                    <button
                        class="btn btn-primary"
                        type="button"
                        id="send-chat-message"
                    >
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
                <div class="mt-1 text-end">
                    <small class="text-muted" id="chat-input-token-estimate"
                        >Tokens: 0</small
                    >
                </div>
            </div>
        </div>
        <div
            class="tab-pane fade p-2"
            id="settings-pane"
            role="tabpanel"
            aria-labelledby="settings-tab-btn"
            tabindex="0"
        >
            <h5><i class="fas fa-robot"></i> LLM Configuration</h5>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="llm-provider-select" class="form-label"
                        >Provider:</label
                    >
                    <select
                        class="form-select"
                        id="llm-provider-select"
                        aria-label="Select LLM Provider"
                    >
                        <option selected value="">Loading providers...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="llm-model-select" class="form-label"
                        >Model:</label
                    >
                    <select
                        class="form-select"
                        id="llm-model-select"
                        aria-label="Select LLM Model"
                        disabled
                    >
                        <option selected value="">Select provider first</option>
                    </select>
                </div>
            </div>
            <button
                type="button"
                class="btn btn-primary btn-sm mb-3"
                id="btn-apply-llm-settings"
            >
                <i class="fas fa-check-circle"></i> Apply LLM Settings
            </button>

            <hr class="my-3" />

            <h5><i class="fas fa-user-cog"></i> System Message</h5>
            <div class="mb-3">
                <label for="system-message-input" class="form-label"
                    >Set System Message for current session:</label
                >
                <textarea
                    class="form-control"
                    id="system-message-input"
                    rows="3"
                    placeholder="e.g., You are a helpful assistant specializing in Python programming."
                ></textarea>
            </div>
            <button
                type="button"
                class="btn btn-primary btn-sm mb-3"
                id="btn-apply-system-message"
            >
                <i class="fas fa-save"></i> Apply System Message
            </button>

            <hr class="my-3" />
            <h6>
                <i class="fas fa-file-code"></i> Prompt Template Values (RAG)
            </h6>
            <p class="small text-muted">
                Define custom key-value pairs for placeholders (e.g.,
                <code>{my_key}</code>) in your RAG prompt template.
            </p>
            <div
                class="table-responsive mb-2"
                style="max-height: 200px; overflow-y: auto"
            >
                <table
                    class="table table-sm table-dark table-striped table-hover"
                    id="prompt-values-table"
                >
                    <thead>
                        <tr>
                            <th scope="col" style="width: 35%">Key</th>
                            <th scope="col" style="width: 45%">Value</th>
                            <th scope="col" style="width: 20%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="prompt-values-tbody">
                        <tr>
                            <td colspan="3" class="text-center text-muted">
                                No prompt values set.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <form
                id="form-add-prompt-value"
                class="row gx-2 gy-2 align-items-end mb-2"
            >
                <div class="col-md-4">
                    <label
                        for="new-prompt-key"
                        class="form-label form-label-sm visually-hidden"
                        >New Key</label
                    >
                    <input
                        type="text"
                        class="form-control form-control-sm"
                        id="new-prompt-key"
                        placeholder="Enter Key"
                        required
                    />
                </div>
                <div class="col-md-5">
                    <label
                        for="new-prompt-value"
                        class="form-label form-label-sm visually-hidden"
                        >New Value</label
                    >
                    <input
                        type="text"
                        class="form-control form-control-sm"
                        id="new-prompt-value"
                        placeholder="Enter Value"
                        required
                    />
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success btn-sm w-100">
                        <i class="fas fa-plus"></i> Add Value
                    </button>
                </div>
            </form>
            <button
                type="button"
                class="btn btn-danger btn-sm"
                id="btn-clear-all-prompt-values"
            >
                <i class="fas fa-trash-alt"></i> Clear All Values
            </button>
            <hr class="my-3" />
            <button
                type="button"
                class="btn btn-secondary btn-sm"
                id="btn-view-app-logs"
            >
                <i class="fas fa-stream"></i> View Application Logs
            </button>
        </div>
    </div>
</nav>

<!-- Modals -->
<div
    class="modal fade"
    id="viewItemContentModal"
    tabindex="-1"
    aria-labelledby="viewItemContentModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="viewItemContentModalLabel">
                    Item Content
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <pre
                    id="modalItemContentDisplay"
                    style="white-space: pre-wrap; word-wrap: break-word"
                ></pre>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade"
    id="contextPreviewModal"
    tabindex="-1"
    aria-labelledby="contextPreviewModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="contextPreviewModalLabel">
                    <i class="fas fa-search-plus"></i> Full Context Preview
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div
                class="modal-body"
                id="modalContextPreviewDisplay"
                style="font-size: 0.85rem"
            >
                <p class="text-muted">Loading context preview...</p>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade"
    id="ingestionModal"
    tabindex="-1"
    aria-labelledby="ingestionModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="ingestionModalLabel">
                    <i class="fas fa-upload"></i> Ingest Data for RAG
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <ul
                    class="nav nav-tabs mb-3"
                    id="ingestionTypeTabs"
                    role="tablist"
                >
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link active"
                            id="ingest-file-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#ingest-file-pane"
                            type="button"
                            role="tab"
                            aria-controls="ingest-file-pane"
                            aria-selected="true"
                        >
                            <i class="fas fa-file-alt"></i> Upload File(s)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link"
                            id="ingest-dir-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#ingest-dir-pane"
                            type="button"
                            role="tab"
                            aria-controls="ingest-dir-pane"
                            aria-selected="false"
                        >
                            <i class="fas fa-folder-open"></i> Upload Directory
                            (ZIP)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                            class="nav-link"
                            id="ingest-git-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#ingest-git-pane"
                            type="button"
                            role="tab"
                            aria-controls="ingest-git-pane"
                            aria-selected="false"
                        >
                            <i class="fab fa-git-alt"></i> Git Repository URL
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="ingestionTypeTabsContent">
                    <div
                        class="tab-pane fade show active"
                        id="ingest-file-pane"
                        role="tabpanel"
                        aria-labelledby="ingest-file-tab"
                    >
                        <form id="form-ingest-file">
                            <div class="mb-3">
                                <label
                                    for="ingest-file-input"
                                    class="form-label"
                                    >Select File(s):</label
                                >
                                <input
                                    class="form-control"
                                    type="file"
                                    id="ingest-file-input"
                                    multiple
                                />
                                <small class="form-text text-muted"
                                    >Select one or more files to ingest.</small
                                >
                            </div>
                            <div class="mb-3">
                                <label
                                    for="ingest-file-collection"
                                    class="form-label"
                                    >Target Collection Name:</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-file-collection"
                                    placeholder="e.g., project_docs_alpha"
                                    required
                                />
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-arrow-circle-up"></i> Start
                                File Ingestion
                            </button>
                        </form>
                    </div>
                    <div
                        class="tab-pane fade"
                        id="ingest-dir-pane"
                        role="tabpanel"
                        aria-labelledby="ingest-dir-tab"
                    >
                        <form id="form-ingest-dir">
                            <div class="mb-3">
                                <label
                                    for="ingest-dir-zip-input"
                                    class="form-label"
                                    >Select Directory ZIP File:</label
                                >
                                <input
                                    class="form-control"
                                    type="file"
                                    id="ingest-dir-zip-input"
                                    accept=".zip"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label
                                    for="ingest-dir-collection"
                                    class="form-label"
                                    >Target Collection Name:</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-dir-collection"
                                    placeholder="e.g., my_codebase_snapshot"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label
                                    for="ingest-dir-repo-name"
                                    class="form-label"
                                    >Repository/Directory Identifier
                                    (Optional):</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-dir-repo-name"
                                    placeholder="e.g., MyProjectV1"
                                />
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-archive"></i> Start Directory
                                Ingestion
                            </button>
                        </form>
                    </div>
                    <div
                        class="tab-pane fade"
                        id="ingest-git-pane"
                        role="tabpanel"
                        aria-labelledby="ingest-git-tab"
                    >
                        <form id="form-ingest-git">
                            <div class="mb-3">
                                <label for="ingest-git-url" class="form-label"
                                    >Git Repository URL:</label
                                >
                                <input
                                    type="url"
                                    class="form-control"
                                    id="ingest-git-url"
                                    placeholder="https://github.com/user/repo.git"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label
                                    for="ingest-git-collection"
                                    class="form-label"
                                    >Target Collection Name:</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-git-collection"
                                    placeholder="e.g., open_source_project_main"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label
                                    for="ingest-git-repo-name"
                                    class="form-label"
                                    >Repository Identifier:</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-git-repo-name"
                                    placeholder="e.g., LLMCoreProject"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label for="ingest-git-ref" class="form-label"
                                    >Branch/Tag/Commit (Optional):</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="ingest-git-ref"
                                    placeholder="e.g., main, v1.0.2, abc1234 (defaults to HEAD)"
                                />
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fab fa-git-square"></i> Start Git
                                Ingestion
                            </button>
                        </form>
                    </div>
                </div>
                <hr />
                <div id="ingestion-status-area" class="mt-3">
                    <p class="small text-muted">
                        Ingestion progress will appear here...
                    </p>
                    <div
                        class="progress"
                        style="height: 10px; display: none"
                        id="ingestion-progress-container"
                    >
                        <div
                            class="progress-bar progress-bar-striped progress-bar-animated"
                            id="ingestion-progress-bar"
                            role="progressbar"
                            style="width: 0%"
                            aria-valuenow="0"
                            aria-valuemin="0"
                            aria-valuemax="100"
                        ></div>
                    </div>
                    <div id="ingestion-result-message" class="mt-2 small"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade"
    id="directRagSearchResultsModal"
    tabindex="-1"
    aria-labelledby="directRagSearchResultsModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="directRagSearchResultsModalLabel">
                    <i class="fas fa-search-location"></i> Direct RAG Search
                    Results
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body" id="directRagSearchResultsBody">
                <p class="text-muted">Search results will appear here...</p>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade"
    id="appLogsModal"
    tabindex="-1"
    aria-labelledby="appLogsModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="appLogsModalLabel">
                    <i class="fas fa-align-left"></i> Application Logs
                </h5>
                <button
                    type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <pre
                    id="app-logs-display"
                    style="
                        max-height: 60vh;
                        overflow-y: auto;
                        font-size: 0.8rem;
                        background-color: #212529;
                        padding: 10px;
                        border-radius: 5px;
                    "
                >
Loading logs...</pre
                >
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div
    id="toast-container"
    class="toast-container position-fixed top-0 end-0 p-3"
    style="z-index: 1056"
></div>

{% endblock %} {% block scripts_extra %}
<script>
    // Basic tab functionality
    document.addEventListener("DOMContentLoaded", function () {
        var triggerTabList = [].slice.call(
            document.querySelectorAll(
                "#mainContentTabs button, #bottomControlTabs button, #ingestionTypeTabs button, #contextSubTabs button",
            ),
        );
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl);
            triggerEl.addEventListener("click", function (event) {
                event.preventDefault();
                tabTrigger.show();
            });
        });
    });
</script>
{% endblock %}
